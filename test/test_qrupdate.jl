import TensorCrossInterpolation: addcol!, addcol, addrow

@testset "Update QR decomposition" begin

    @testset "Add column to QR decomposition" begin
        A0 = [
            0.103204 0.404923 0.71283 0.721149 0.426933
            0.677778 0.167051 1.25776 0.756173 0.969701
            0.393857 0.584354 0.0567795 0.75428 0.911808
            0.604135 0.0667156 0.506892 0.938319 0.832399
            0.837549 0.204377 0.357999 0.695451 0.678266
            0.549381 0.288197 0.963816 0.835326 0.0935915
            0.399178 0.209639 0.132729 0.0183668 0.0738901
            0.802663 0.227476 0.584135 0.497224 0.400964
            0.174579 0.0704432 0.0305634 0.794177 0.320688
            0.854738 0.778616 0.0368113 0.762819 0.352681
        ]
        Q0, R0 = qr(A0)
        newcol = [
            0.3502321828495518
            0.44436122564550296
            0.799904378881173
            0.04500530036181416
            0.8715496808109421
            0.9042632705525689
            0.658010748538443
            0.30846156409452796
            0.3712643152531836
            0.9170658109638314
        ]

        for colindex in 0:5
            A1 = [A0[:, 1:colindex] newcol A0[:, colindex+1:end]]
            Q1, R1 = qr(A1)
            Qu, Ru = addcol(Q0, R0, newcol, colindex)
            @test A1 ≈ Qu * Ru
        end
    end

    @testset "Add row to QR decomposition" begin
        A0 = [
            0.844189 0.582407 0.698516 0.574484 0.721469
            0.897556 0.17685 0.086923 0.777056 0.259299
            0.636841 0.529518 0.576299 0.645368 0.0959592
            0.233074 0.175133 0.310966 0.914529 0.835181
            0.359447 0.104493 0.977307 0.537284 0.0143637
            0.253319 0.459537 0.490894 0.778829 0.386206
            0.044476 0.496289 0.941943 0.263432 0.756449
            0.965188 0.589072 0.530227 0.473846 0.0102282
            0.497288 0.720836 0.765594 0.965763 0.862489
            0.985062 0.700547 0.450472 0.696387 0.168625
        ]
        Q0, R0 = qr(A0)
        newrow = [
            0.21940804564401373
            0.01228333820135108
            0.9920336471642831
            0.3477262783426138
            0.3796160550524469
        ]

        for rowindex in 0:5
            A1 = [A0[1:rowindex, :]; newrow'; A0[rowindex+1:end, :]]
            Q1, R1 = qr(A1)
            Qu, Ru = addrow(Q0, R0, newrow, rowindex)
            @test A1 ≈ Qu * Ru
        end
    end

end
